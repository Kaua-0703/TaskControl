<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Novo Usuário</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light p-4">

    <div class="container">

        <form id="formCadastrarUsuario" class="card shadow-sm">

            <div class="card-header text-center fw-bold">
                Cadastro de Novo Usuário
            </div>

            <div class="card-body">

                <div class="mb-3">
                    <label class="form-label">Nome</label>
                    <input type="text" class="form-control" id="nome" placeholder="Digite o nome">
                </div>

                <div class="mb-3">
                    <label class="form-label">E-mail</label>
                    <input type="email" class="form-control" id="email" placeholder="Digite o e-mail">
                </div>

                <div class="mb-3">
                    <label class="form-label">Senha</label>
                    <input type="password" class="form-control" id="senha" placeholder="Digite a senha">
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="admin">
                    <label class="form-check-label" for="admin">
                        Administrador
                    </label>
                </div>

                <div id="msg" class="alert alert-danger d-none"></div>

            </div>

            <div class="card-footer text-center">
                <button type="submit" class="btn btn-success" id="btnCadastrar">
                    Cadastrar usuário
                </button>
                <a href="dashboardusuario.html" class="btn btn-secondary ms-2">
                    Voltar
                </a>
            </div>

        </form>

    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script>
        $(function () {

            $("#formCadastrarUsuario").on("submit", function (e) {
                e.preventDefault();

                $("#msg").addClass("d-none").text("");

                var nome = $("#nome").val().trim();
                var email = $("#email").val().trim();
                var senha = $("#senha").val();
                var admin = $("#admin").is(":checked");

                $.ajax({
                    url: "api/usuario.php?acao=cadastrar",
                    method: "POST",
                    data: {
                        nome: nome,
                        email: email,
                        senha: senha,
                        admin: admin
                    },
                    dataType: "text"
                })
                    .done(function (res) {
                        if (res.trim() === "OK") {
                            window.location.href = "dashboardusuario.html";
                        } else {
                            $("#msg").removeClass("d-none")
                                .text("Erro no cadastro de usuário. " + res);
                        }
                    })
                    .fail(function (xhr) {
                        var txt = xhr.responseText && xhr.responseText.trim() !== ""
                            ? xhr.responseText
                            : "Erro ao cadastrar usuário.";

                        $("#msg").removeClass("d-none").text(txt);
                    })
                    .always(function () {
                        $("#btnCadastrar").prop("disabled", false);
                    });
            });

        });

        function excluirUsuario(id) {

            if (!confirm("Deseja realmente excluir este usuário?")) {
                return;
            }

            fetch("api/usuario.php?acao=excluir", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: "id=" + id
            })
                .then(r => r.text())
                .then(res => {
                    if (res.trim() === "OK") {
                        carregarUsuarios();
                    } else {
                        alert(res);
                    }
                })
                .catch(() => {
                    alert("Erro ao excluir usuário");
                });
        }
    </script>

</body>

</html>