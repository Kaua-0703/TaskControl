<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Dashboard de Tarefas</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light p-3">

    <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-white shadow-sm rounded">

        <div class="d-flex align-items-center gap-2">
            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                style="width:40px; height:40px;">
                üë§
            </div>
            <span class="fw-semibold" id="nomeUsuario">Carregando...</span>
        </div>

        <div class="d-flex gap-2">

            <a href="login.html" class="btn btn-outline-danger">
                Logout
            </a>

            <button class="btn btn-secondary d-none" id="btnUsuario">
                Usu√°rios
            </button>

            <a href="novatarefa.html" class="btn btn-success">
                ‚ûï Nova Tarefa
            </a>

        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover bg-white shadow-sm w-100">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>ID Usu√°rio</th>
                    <th>Nome</th>
                    <th>T√≠tulo</th>
                    <th>Descri√ß√£o</th>
                    <th>Cria√ß√£o</th>
                    <th>Limite</th>
                    <th>Status</th>
                    <th class="text-end">A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="corpoTarefas"></tbody>
        </table>
    </div>

    <div class="d-flex justify-content-center align-items-center gap-3 mt-3">
        <button id="btnAnterior" class="btn btn-secondary btn-sm" onclick="carregarTarefas(paginaAtual - 1)">
            ‚¨Ö Anterior
        </button>

        <span class="fw-semibold">
            P√°gina <span id="paginaAtualTexto">1</span>
        </span>

        <button class="btn btn-secondary btn-sm" onclick="carregarTarefas(paginaAtual + 1)">
            Pr√≥xima ‚û°
        </button>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script>
        let paginaAtual = 1;

        function carregarTarefas(pagina = 1) {
            if (pagina < 1) return;

            paginaAtual = pagina;

            fetch(`api/tarefa.php?acao=listar&pagina=${pagina}`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById("corpoTarefas").innerHTML = html;
                    document.getElementById("paginaAtualTexto").innerText = paginaAtual;
                    document.getElementById("btnAnterior").disabled = paginaAtual === 1;
                });
        }

        carregarTarefas();

        function botaoUsuario() {
            return document.getElementById("btnUsuario");
        }
        fetch("api/usuario_logado.php")
            .then(res => res.json())
            .then(usuario => {
                document.getElementById("nomeUsuario").innerText = usuario.nome;

                if (usuario.admin == 1) {

                    btnUsuario.classList.remove("d-none");

                    btnUsuario.addEventListener("click", () => {
                        window.location.href = "dashboardusuario.html";
                    });
                } else {

                    btnUsuario.classList.add("d-none");

                }
            })
            .catch(() => {
                document.getElementById("nomeUsuario").innerText = "Usu√°rio";
                btnUsuario.style.display = "none";
            });


        function excluirTarefa(id) {
            if (!confirm("Deseja excluir esta tarefa?")) return;

            $.post("api/tarefa.php?acao=excluir", { id })
                .done(() => carregarTarefas(paginaAtual))
                .fail(() => alert("Erro ao excluir a tarefa"));
        }

        function editarTarefa(id) {
            window.location.href = `editartarefa.html?id=${id}`;
        }

        function reabrirTarefa(id) {
            if (!confirm("Reabrir tarefa?")) return;

            $.post({ url: "api/tarefa.php?acao=reabrir", data: { id }, dataType: "text" })
                .done(function (res) { carregarTarefas(paginaAtual); })
                .fail(function (xhr, status, error) {
                    console.log("STATUS:", xhr.status);
                    console.log("STATUS TEXT:", status);
                    console.log("ERROR:", error);
                    console.log("RESPONSE:", xhr.responseText);

                    alert("Erro ao reabrir a tarefa:\n" + xhr.responseText);
                });
        }

        fetch("api/usuario_logado.php")
            .then(res => res.json())
            .then(usuario => {
                document.getElementById("nomeUsuario").innerText = usuario.nome;
            })
            .catch(() => {
                document.getElementById("nomeUsuario").innerText = "Usu√°rio";
            });

        function concluirTarefa(id) {
            if (!confirm("Marcar tarefa como conclu√≠da?")) return;

            $.post({ url: "api/tarefa.php?acao=concluir", data: { id }, dataType: "text" })
                .done(() => carregarTarefas(paginaAtual))
                .fail(function (xhr, status, error) {

                    alert("Erro ao concluir a tarefa:\n" + xhr.responseText);
                });
        }

        fetch("api/usuario_logado.php")
            .then(res => res.json())
            .then(usuario => {
                document.getElementById("nomeUsuario").innerText = usuario.nome;
            })
            .catch(() => {
                document.getElementById("nomeUsuario").innerText = "Usu√°rio";
            });

    </script>

</body>

</html>